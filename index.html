    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Image Search App</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <style>
            body {
                font-family: 'Inter', sans-serif;
                background-image: url('https://placehold.co/1920x1080/E0F2FE/C4E1F4?text=Background');
                background-size: cover;
                background-attachment: fixed;
                background-position: center;
            }
            .glassmorphism {
                background: rgba(255, 255, 255, 0.4);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .product-card {
                min-height: 380px;
                background: rgba(255, 255, 255, 0.6);
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            }
        </style>
    </head>
    <body class="text-gray-800">

        <div class="container mx-auto p-4 md:p-8">
            <header class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-2 drop-shadow-md">Visual Product Search</h1>
                <p class="text-lg text-gray-700">Find similar products by uploading an image.</p>
            </header>

            <main>
                <div class="glassmorphism p-6 md:p-10 rounded-lg shadow-xl max-w-2xl mx-auto">
                    <form id="upload-form" enctype="multipart/form-data" class="space-y-6">
                        <div class="flex flex-col items-center justify-center border-2 border-gray-300 border-dashed rounded-lg p-6 hover:border-blue-500 transition-colors duration-200 cursor-pointer" id="drop-area">
                            <svg class="w-16 h-16 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v8"></path>
                            </svg>
                            <p class="mt-2 text-sm text-gray-600">Drag and drop an image here, or click to select a file.</p>
                            <input type="file" id="image-input" name="image" class="hidden" accept="image/*">
                            <img id="image-preview" class="mt-4 hidden max-h-40 rounded-lg shadow-md" src="#" alt="Image Preview">
                        </div>

                        <div class="grid sm:grid-cols-2 gap-4">
                            <div>
                                <label for="product_type_filter" class="block text-sm font-medium text-gray-700">Filter by Product Type</label>
                                <select id="product_type_filter" name="product_type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-white/50">
                                    <option>All</option>
                                </select>
                            </div>
                            <div>
                                <label for="vendor_filter" class="block text-sm font-medium text-gray-700">Filter by Vendor</label>
                                <select id="vendor_filter" name="vendor" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-white/50">
                                    <option>All</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" id="submit-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                            <span id="button-text">Search for Similar Products</span>
                            <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-6 w-6 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </form>
                </div>
                
                <!-- Result Display Section -->
                <div id="results-section" class="mt-12 hidden">
                    <h2 class="text-2xl font-bold text-gray-900 text-center mb-6 drop-shadow-md">Search Results</h2>
                    <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Product cards will be inserted here by JavaScript -->
                    </div>
                </div>

                <!-- Message Box -->
                <div id="message-box" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white text-center transition-opacity duration-300 hidden"></div>

            </main>
        </div>

        <script>
            const form = document.getElementById('upload-form');
            const imageInput = document.getElementById('image-input');
            const imagePreview = document.getElementById('image-preview');
            const dropArea = document.getElementById('drop-area');
            const submitButton = document.getElementById('submit-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const buttonText = document.getElementById('button-text');
            const resultsSection = document.getElementById('results-section');
            const resultsGrid = document.getElementById('results-grid');
            const messageBox = document.getElementById('message-box');
            const typeFilter = document.getElementById('product_type_filter');
            const vendorFilter = document.getElementById('vendor_filter');


            // Drag and drop functionality
            ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            ;['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.add('border-blue-500'), false);
            });

            ;['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.remove('border-blue-500'), false);
            });

            dropArea.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            dropArea.addEventListener('click', () => {
                imageInput.click();
            });

            imageInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            function handleFiles(files) {
                if (files.length === 0) return;
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Fetch filter options on page load
            async function fetchFilterOptions() {
                try {
                    const response = await fetch('/get_filter_options');
                    if (!response.ok) {
                        throw new Error('Failed to fetch filter options.');
                    }
                    const filters = await response.json();
                    
                    filters.product_types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        typeFilter.appendChild(option);
                    });

                    filters.vendors.forEach(vendor => {
                        const option = document.createElement('option');
                        option.value = vendor;
                        option.textContent = vendor;
                        vendorFilter.appendChild(option);
                    });

                } catch (error) {
                    console.error(error);
                    showMessage('Failed to load filter options. Try refreshing the page.', 'bg-red-500');
                }
            }

            // Form submission handler
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const file = imageInput.files[0];
                if (!file) {
                    showMessage('Please select an image first.', 'bg-red-500');
                    return;
                }

                const formData = new FormData(form);
                formData.append('image', file);
                formData.append('product_type', typeFilter.value);
                formData.append('vendor', vendorFilter.value);
                
                showLoading(true);
                
                try {
                    const response = await fetch('/search', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                        if (result.status === 'success' && result.matches.length > 0) {
                            displayResults(result.matches);
                            showMessage(`${result.count} similar products found!`, 'bg-green-500');
                        } else {
                            displayResults([]); // Clear previous results
                            showMessage('No similar products found.', 'bg-yellow-500');
                        }
                    } else {
                        throw new Error(result.error || 'Server error occurred.');
                    }

                } catch (error) {
                    console.error('Search failed:', error);
                    displayResults([]);
                    showMessage(`Search failed: ${error.message}`, 'bg-red-500');
                } finally {
                    showLoading(false);
                }
            });

            function showLoading(isLoading) {
                submitButton.disabled = isLoading;
                if (isLoading) {
                    loadingSpinner.classList.remove('hidden');
                    buttonText.classList.add('hidden');
                } else {
                    loadingSpinner.classList.add('hidden');
                    buttonText.classList.remove('hidden');
                }
            }

            function displayResults(matches) {
                resultsGrid.innerHTML = '';
                if (matches.length > 0) {
                    resultsSection.classList.remove('hidden');
                    matches.forEach(product => {
                        const card = createProductCard(product);
                        resultsGrid.appendChild(card);
                    });
                } else {
                    resultsSection.classList.add('hidden');
                }
            }

            function createProductCard(product) {
                const card = document.createElement('div');
                card.className = 'product-card rounded-lg shadow-md p-4 flex flex-col justify-between';
                const price = product.Price !== undefined && product.Price !== null ? `$${product.Price}` : '$N/A';

                card.innerHTML = `
                    <div class="flex-shrink-0 flex items-center justify-center">
                        <img src="/data/product_images/${product.Handle}.jpg" alt="${product.Title}" class="w-full h-48 object-contain rounded-md mb-4 onerror="this.onerror=null;this.src='https://placehold.co/400x400/CCCCCC/333333?text=Image+Unavailable';">
                    </div>
                    <div class="flex-grow">
                        <h3 class="text-md font-semibold text-gray-900 leading-tight mb-2">${product.Title || 'Untitled Product'}</h3>
                        <p class="text-sm text-gray-600 mb-1"><strong>Vendor:</strong> ${product.Vendor || 'N/A'}</p>
                        <p class="text-sm text-gray-600 mb-1"><strong>Category:</strong> ${product.Type || 'N/A'}</p>
                    </div>
                    <div class="mt-4 text-right">
                        <span class="text-xl font-bold text-blue-600">${price}</span>
                    </div>
                `;
                return card;
            }

            function showMessage(message, type) {
                messageBox.textContent = message;
                messageBox.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white text-center transition-opacity duration-300 ${type}`;
                messageBox.classList.remove('hidden');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 5000);
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', () => {
                fetchFilterOptions();
            });
        </script>

    </body>
    </html>
    